name: php
version: 0.2.3
inherits: wercker/ubuntu12.04-webessentials@0.0.3
type : main
platform : ubuntu@12.04
description : php
keywords:
  - php
packages :
  - php@5.3
  - php@5.4
  - php@5.5
script : |
  # Start with a blank ~/.bashrc file
  truncate -s0 .bashrc
  echo 'export PATH="/usr/local/bin:$PATH"' > .bashrc

  # Add repository that contains php packages
  sudo add-apt-repository ppa:ondrej/php5 -y
  sudo apt-get update

  # Needed to build PHP with php-build
  sudo apt-get build-dep php5-cli
  sudo apt-get install libreadline-dev
  sudo apt-get install re2c
  sudo apt-get install flex
  sudo apt-get install bison

  # Install php-build
  git clone https://github.com/pjvds/php-build.git
  sudo ./php-build/install.sh
  rm -rf ./php-build
  sudo chown -R ubuntu $HOME
  sudo chown -R ubuntu /usr/local/share/php-build
  export PHP_BUILD_VERSIONS_DIR="$HOME/.phpenv/versions"

  # Validate php-build
  php-build --version

  # Intall php-env
  git clone https://github.com/CHH/phpenv.git
  sudo ./phpenv/bin/phpenv-install.sh
  echo 'export PATH="/home/ubuntu/.phpenv/bin:$PATH"' >> .bashrc
  echo 'eval "$(phpenv init -)"' >> .bashrc
  rm -rf ./phpenv
  sudo chown -R ubuntu $HOME
  source .bashrc

  # Validate phpenv
  phpenv --version

  # Build PHP versions
  #php-build -i development --pear 5.3.26 $HOME/.phpenv/versions/5.3 --verbose
  #php-build -i development --pear 5.4.16 $HOME/.phpenv/versions/5.4 --verbose
  #php-build -i development --pear 5.5.0RC3 $HOME/.phpenv/versions/5.5 --verbose
  ./php-build.sh "5.3.26" "5.3"

  # Install composer
  curl -sS https://getcomposer.org/installer | php
  mv composer.phar /usr/local/bin/composer

  # Install PHPUnit
  wget http://pear.phpunit.de/get/phpunit.phar
  chmod +x phpunit.phar
  mv phpunit.phar /usr/local/bin/phpunit

  # Install atoum
  wget http://downloads.atoum.org/nightly/mageekguy.atoum.phar
  chmod +x mageekguy.atoum.phar
  mv mageekguy.atoum.phar /usr/local/bin/atoum

  # Switch to php 5.4
  phpenv rehash
  phpenv global 5.4
  php --version

# box-detect:
#   priority : 1200
#   version :
#   detect:
#     - files:
#       - composer.json
